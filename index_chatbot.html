<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedyBuddy Chatbot</title>
  <link rel="stylesheet" href="style_cb.css">
  <style>
    /* Location permission popup styles */
    #location-permission {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    #location-permission.hidden {
      display: none;
    }
    
    .permission-box {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 350px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .permission-box h3 {
      margin-top: 0;
      color: #007bff;
    }
    
    .permission-box p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .permission-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    
    .permission-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    #allow-location {
      background: #007bff;
      color: white;
    }
    
    #allow-location:hover {
      background: #0056b3;
    }
    
    #deny-location {
      background: #f8f9fa;
      color: #6c757d;
    }
    
    #deny-location:hover {
      background: #e9ecef;
    }
    
    /* Hospital list styles */
    .hospital-item {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .hospital-name {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 5px;
    }
    
    .hospital-address {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    
    .hospital-distance {
      color: #28a745;
      font-size: 0.85em;
    }
    
    .location-icon {
      color: #007bff;
      margin-right: 5px;
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      padding: 10px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #888;
      border-radius: 50%;
      margin: 0 3px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typingAnimation {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-5px);
      }
    }
  </style>
</head>
<body>
  <!-- Location permission popup -->
  <div id="location-permission">
    <div class="permission-box">
      <h3>Location Access Needed</h3>
      <p>MedyBuddy would like to access your location to find nearby hospitals and clinics. Your location data is not stored on our servers.</p>
      <div class="permission-buttons">
        <button id="allow-location" class="permission-btn">Allow</button>
        <button id="deny-location" class="permission-btn">Deny</button>
      </div>
    </div>
  </div>

  <!-- Floating button -->
  <div id="chat-toggle">
    <img src="ABC.png" alt="MedyBuddy Logo">
    <span id="chat-label">Need any help? Ask MedyBuddy</span>
  </div>

  <!-- Chat container (hidden by default) -->
  <div id="chat-container" class="hidden">
    <div id="chat-header">
      <span>ðŸ’™ MedyBuddy</span>
      <button id="close-chat">Ã—</button>
    </div>
    <div id="chat-box"></div>
    <div id="input-area">
      <input type="text" id="input" placeholder="Type your message...">
      <button id="send">âž¤</button>
    </div>
  </div>

  <script>
    // DOM elements
    const locationPermission = document.getElementById('location-permission');
    const allowLocationBtn = document.getElementById('allow-location');
    const denyLocationBtn = document.getElementById('deny-location');
    const chatContainer = document.getElementById('chat-container');
    const chatToggle = document.getElementById('chat-toggle');
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const closeChatBtn = document.getElementById('close-chat');

    // Generate a unique session ID
    const sessionId = generateSessionId();
    let locationAllowed = false;
    let userLocation = null;

    // Show location permission popup when page loads
    window.addEventListener('load', () => {
      // Show permission popup after a short delay
      setTimeout(() => {
        locationPermission.classList.remove('hidden');
      }, 1000);
    });

    // Handle location permission
    allowLocationBtn.addEventListener('click', () => {
      locationPermission.classList.add('hidden');
      locationAllowed = true;
      getLocation();
    });

    denyLocationBtn.addEventListener('click', () => {
      locationPermission.classList.add('hidden');
      appendMessage("You've denied location access. You can still use MedyBuddy, but some features like finding nearby hospitals won't be available.", 'bot');
    });

    // Get user's location
    function getLocation() {
      if (!navigator.geolocation) {
        appendMessage("Geolocation is not supported by your browser.", 'bot');
        return;
      }

      showTypingIndicator();
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          removeTypingIndicator();
          appendMessage("Location access granted! I can now help you find nearby hospitals and clinics.", 'bot');
        },
        (error) => {
          removeTypingIndicator();
          appendMessage("Unable to retrieve your location. Please check your location settings.", 'bot');
        }
      );
    }

    // Toggle chat on logo click
    chatToggle.addEventListener('click', () => {
      chatContainer.classList.toggle('hidden');
      if (!chatContainer.classList.contains('hidden')) {
        setTimeout(() => {
          chatContainer.classList.add('visible');
          input.focus();
        }, 10);
      } else {
        chatContainer.classList.remove('visible');
      }
    });

    // Close chat button
    closeChatBtn.addEventListener('click', () => {
      chatContainer.classList.add('hidden');
      chatContainer.classList.remove('visible');
    });

    // Append message to chat
    function appendMessage(text, sender) {
      const msg = document.createElement('div');
      msg.className = 'message ' + sender;
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Show typing indicator
    function showTypingIndicator() {
      const typing = document.createElement('div');
      typing.id = 'typing-indicator';
      typing.className = 'message bot';
      
      const typingContainer = document.createElement('div');
      typingContainer.className = 'typing-indicator';
      
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        typingContainer.appendChild(dot);
      }
      
      typing.appendChild(typingContainer);
      chatBox.appendChild(typing);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Remove typing indicator
    function removeTypingIndicator() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    // Find nearby hospitals (mock function for now)
    function findNearbyHospitals() {
      showTypingIndicator();
      
      // Simulate API call delay
      setTimeout(() => {
        removeTypingIndicator();
        
        // Mock hospital data - replace with actual API call to your database
        const mockHospitals = [
          { name: "City General Hospital", address: "123 Main Street", distance: "0.8 km" },
          { name: "Community Health Center", address: "456 Oak Avenue", distance: "1.2 km" },
          { name: "MedFirst Clinic", address: "789 Pine Road", distance: "1.5 km" },
          { name: "Urgent Care Facility", address: "321 Elm Boulevard", distance: "2.1 km" }
        ];
        
        appendMessage("Here are the nearest medical facilities to your location:", 'bot');
        
        // Create hospital list
        const hospitalList = document.createElement('div');
        hospitalList.style.marginTop = '10px';
        
        mockHospitals.forEach(hospital => {
          const hospitalItem = document.createElement('div');
          hospitalItem.className = 'hospital-item';
          
          hospitalItem.innerHTML = `
            <div class="hospital-name">${hospital.name}</div>
            <div class="hospital-address">${hospital.address}</div>
            <div class="hospital-distance">${hospital.distance} away</div>
          `;
          
          hospitalList.appendChild(hospitalItem);
        });
        
        const botMessage = document.createElement('div');
        botMessage.className = 'message bot';
        botMessage.appendChild(hospitalList);
        
        chatBox.appendChild(botMessage);
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 1500);
    }

    // Process user message
    function processMessage(message) {
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('hospital') || lowerMessage.includes('clinic') || 
          lowerMessage.includes('nearby') || lowerMessage.includes('medical')) {
        
        if (locationAllowed && userLocation) {
          findNearbyHospitals();
        } else if (locationAllowed) {
          getLocation();
          setTimeout(findNearbyHospitals, 2000);
        } else {
          appendMessage("To find nearby hospitals, I need your location permission. Please type 'location' to enable location access.", 'bot');
        }
        return true;
      }
      
      if (lowerMessage.includes('location') || lowerMessage.includes('permission')) {
        if (locationAllowed) {
          appendMessage("You've already granted location permission. I can help you find nearby hospitals.", 'bot');
        } else {
          locationPermission.classList.remove('hidden');
        }
        return true;
      }
      
      return false;
    }

    // Send message function
    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;

      appendMessage(message, 'user');
      input.value = '';
      
      // Check if it's a special command
      const handled = processMessage(message);
      
      if (!handled) {
        showTypingIndicator();
        
        try {
          const res = await fetch('http://localhost:3000/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, sessionId }),
          });

          const data = await res.json();
          removeTypingIndicator();
          appendMessage(data.reply, 'bot');
        } catch (error) {
          removeTypingIndicator();
          appendMessage("âš ï¸ Error: Could not reach MedyBuddy", 'bot');
        }
      }
    }

    // Generate session ID
    function generateSessionId() {
      return 'session-' + Math.random().toString(36).substr(2, 9);
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Add initial bot message when chat is opened for the first time
    chatToggle.addEventListener('click', function firstOpen() {
      if (chatBox.children.length === 0) {
        appendMessage("Hello! I'm MedyBuddy. How can I help you today?", 'bot');
      }
      chatToggle.removeEventListener('click', firstOpen);
    });
  </script>
</body>
</html>